var localMapApp=function(){var e=function(){function e(e){void 0===e?(localMapApp.latitude=40.7058316,localMapApp.longitude=-74.2581961):(localMapApp.latitude=e.coords.latitude,localMapApp.longitude=e.coords.longitude),localMapApp.latlng=new google.maps.LatLng(localMapApp.latitude,localMapApp.longitude),localMapApp.map=new google.maps.Map(t,{center:localMapApp.latlng,zoom:11,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP}),google.maps.event.addListenerOnce(localMapApp.map,"idle",function(){ko.applyBindings(viewModel),viewModel.fetchVenues()})}function o(o){1==o.code?alert("Error: Access is denied! Kindly allow your location to be shared and try again!"):2==o.code&&(alert("Unable to retrieve your current location! Presenting the local map of NYC"),e())}function a(){var a={timeout:6e4,maximumAge:35e3};navigator.geolocation.getCurrentPosition(e,o,a)}var t=document.getElementById("map-canvas");navigator.geolocation?a():alert("Sorry, browser does not support geolocation!")},o=function(){alert("Sorry, Google maps failed to load. Please try again later.")};return{initMap:e,googleError:o}}(),Venue=function(e){e.fqUrl=ko.computed(function(){return"https://foursquare.com/v/"+e.id}),e.currWeather=ko.observable(),e.currTemp=ko.observable(),e.currWind=ko.observable(),e.weatherIcon=ko.observable(),e.displayDetails=ko.observable(!1),e.position=new google.maps.LatLng(e.location.lat,e.location.lng),e.marker=new google.maps.Marker({position:e.position,map:localMapApp.map,animation:google.maps.Animation.DROP,title:e.name}),e.infowindow=new google.maps.InfoWindow({maxWidth:300})},viewModel=new function(){var e=this;e.category=ko.observableArray(CATEGORIES),e.selectedCatKey=ko.observable(),e.venueSuggestions=ko.observable(!1),e.showResults=ko.observable(!1),e.limit=ko.observable(25),e.venues=ko.observableArray([]),e.venuesList=ko.observableArray([]),e.markersArr=ko.observableArray([]),e.toggleResults=function(o,a){e.showResults(!e.showResults())},e.filterList=function(o,a){"All"===o?e.limit=ko.observable(25):e.limit=ko.observable(5),e.fetchVenues(a)},e.resetMarkers=function(){0!==e.markersArr().length&&$.each(e.markersArr(),function(e,o){o.setMap(null)})},e.fetchVenues=function(o){var a,t,n,i,l,r,s,p=localMapApp.latitude+","+localMapApp.longitude,c=new google.maps.LatLngBounds,u=new google.maps.places.PlacesService(localMapApp.map);void 0===o&&(o="",$.each(e.category(),function(e,a){o+=a.key+","}),o=o.slice(0,-1)),e.selectedCatKey(o),$.getJSON({url:encodeURI("https://api.foursquare.com/v2/venues/search?ll="+p+"&categoryId="+o+"&limit="+e.limit()+"&intent=browse&radius=8000&client_id=XK2FF2P2QZZSB1HPAFQFC1VEBRUM0AYXKVSB3G14MN3IXMLT&client_secret=S5MD24CPFUC2TXWRSKW1URKHWJ1JAD44E4XMQO5LWWZJHOS5&v=20160419")}).done(function(o){a=o.response.venues,ko.utils.arrayMap(a,function(e){return new Venue(e)}),e.venues(a),e.resetMarkers(),$.each(e.venues(),function(o,a){t=a.marker,l=a.infowindow,e.markersArr.push(t),c.extend(t.position);var p=function(e,o){i="",s=o==google.maps.places.PlacesServiceStatus.OK&&void 0!==e[0].photos?e[0].photos[0].getUrl({maxWidth:250,maxHeight:150}):"./css/images/image-not-found.png",i='<div id="markerContent"><img src='+s+' alt="Venue Image"/><h5>'+a.name+"</h5><p>Category: "+a.categories[0].name+"</p>",l.setContent(i)};r={location:a.position,radius:"100",keyword:a.name};var d=function(o,t,i){return function(){u.nearbySearch(o,t),n=i,n.setAnimation(google.maps.Animation.BOUNCE),localMapApp.map.panTo(i.getPosition()),localMapApp.map.setZoom(18),a.displayDetails()||e.displayVenueDetails(a.location.postalCode,a),l.open(localMapApp.map,i)}};google.maps.event.addListener(t,"click",d(r,p,t)),google.maps.event.addListener(l,"closeclick",function(){n.setAnimation(null)})}),e.venuesList($.map(e.venues(),function(e){return{label:e.name,id:e.id}})),$(".venue-search").autocomplete({source:e.venuesList(),autoFocus:!0,minLength:0,select:function(o,a){$.each(e.venues(),function(o,n){return n.id===a.item.id?(e.venues(n),n.marker.setVisible(!0),c.extend(t.position),localMapApp.map.setCenter(t.position),e.displayVenueDetails(n.location.postalCode,n),e.showResults(!0),!1):void 0})},response:function(o,t){if(0===t.content.length)e.venueSuggestions(!0);else{e.venueSuggestions(!1),e.venues(a);var n=[];$.each(e.venues(),function(e,o){o.marker.setVisible(!1),$.each(t.content,function(e,a){return o.name.indexOf(a.label)>-1?(n.push(o),o.marker.setVisible(!0),!1):void 0})}),e.venues(n)}}}),localMapApp.map.fitBounds(c)}).fail(function(){alert("Unable to retrieve any results for your location. Please try after some time.")})},e.displayVenueDetails=function(e,o){o.displayDetails(!o.displayDetails()),o.displayDetails()&&(google.maps.event.trigger(o.marker,"click"),$.getJSON({url:encodeURI("http://api.openweathermap.org/data/2.5/weather?zip="+e+"&APPID=3ba479c50b70ef8527458684a4df9608&units=metric")}).done(function(e){localStorage.weatherCache=JSON.stringify({timestamp:(new Date).getTime(),data:e}),o.currWeather(e.weather[0].description),o.currTemp(e.main.temp),o.currWind(e.wind.speed),o.weatherIcon("http://openweathermap.org/img/w/"+e.weather[0].icon+".png")}).fail(function(){$(".venue-weather").hide()}))}};